<link rel="import" href="../../bower_components/polymer/polymer.html">
<script src="../../bower_components/autobahnjs/autobahn.js"></script>

<!--
`cb-connect` is an element which connects to a [crossbar.io](http://crossbar.io) router.
Simply add the `cb-connect` element to your index.html or custom element. As soon as the connection is established, `cb-connect` will fire an event, which contains the session details, to the target element.

Example:

    <cb-connect target-element="main-page"></cb-connect>
    <main-page></main-page> 

In the `main-page` element you can add an event listener:

      Polymer({

        is: 'main-page',

        properties: {
        },

        listeners: {
          'crossbar-connected': 'receivedEvent'
        },

        receivedEvent: function(e) {
          console.log('received crossbar session object', e.detail);
        }
      });

@demo demo/index.html 
-->


<dom-module id="cb-connect">


  <script>
    Polymer({

      is: 'cb-connect',

      /**
       * Fired to target element when connection to crossbar router is established
       *
       * @event crossbar-connected
       */

      properties: {
        //crossbar realm
        realm: {
          type: String,
          value: 'polymer_meetup'
        },
        //websocket uri
        wsuri: {
          type: String,
          value: 'ws://localhost:8099/ws'
        },
        //target element which receives session event
        targetElement: {
          type: String
        },
        // crossbar session object
        session: {
          type: Object,
          notify: true
        }
      },

      attached: function() {

        var me = this;

        var establishConnection = function() {

            // the WAMP connection to the Router
            //
            var connection = new autobahn.Connection({
               url: me.wsuri,
               realm: me.realm
            });

            // fired when connection is established and session attached
            //
            connection.onopen = function (session, details) {
                console.log("Connected to crossbar router");
                // absession = session;

                if(me.targetElement) {
                  console.log('event fired');
                  me.fire('crossbar-connected', session, {node: document.querySelector('main-page')});
                }

                me.session = session;

            };

            connection.onclose = function (reason, details) {
                console.log('not Connected, reason:', reason, details);
            };

            connection.open();
        }

        establishConnection();        
      }

    });
  </script>
</dom-module>
